/**
 * Script for the visualizer webpage.
 */

$(document).ready(function(){
    // Register the file-loading event
    $('#file-input').on('change', readSingleFile);
})

// File reading stuff

/// Handler passed to the file selector, called when a file is selected.
function readSingleFile(e) {
    var file = e.target.files[0];
    if (!file) return;
        
    var reader = new FileReader();
    reader.onload = e => handleFile(e.target.result);

    reader.readAsText(file);
}

/// Handler passed to the FileReader, called with the contents of the selected file.
function handleFile(contents) {
    var data = JSON.parse(contents);
    cleanData(data);
    console.log(data);
    visualizer = new Visualizer(data);
}

/// Cleans up the JSON that boost generated by parsing strings back to numerics where needed.
function cleanData(data){
    for(i in data.towns){
        town = data.towns[i];
        town.size = parseInt(town.size);
        town.lat = parseFloat(town.lat);
        town.long = parseFloat(town.long);
    }
    for(i in data.days){
        day = data.days[i];
        for(town in day)
            day[town] = parseInt(day[town]);
    }
}

// Remove all spaces from a given string.
function noSpace(s){ return s.split(" ").join(''); }

// Class: Visualizer

/// Make a new Visualizer from the given data.
/// mode = "table": The data is visualized as a table view.
/// mode = "map"  : The data is visualized in a map view. 
var Visualizer = function(data, mode = "table"){
    this.days = data.days;
    this.towns = data.towns;
    this.mode = mode;
    this.initialize();
}

/// Initialize the Visualizer.
Visualizer.prototype.initialize = function(){
    this.maxDays = this.days.length;
    $('.days').text(this.maxDays);
    // set up the view
    this.makeView();
    this.updateDay(0);
}

/// Prepare the HTML document with the basic framework for our view.
Visualizer.prototype.makeView = function(){
    if( this.mode == "table")
        this.makeTable();
    else
        this.makeMap();
}

/// Prepare the HTML document with a basic table.
Visualizer.prototype.makeTable = function(){
    // Clear the current view
    $view = $("#view");
    $view.html('');

    // Make a table
    $table = $('<table>', {class:'table table-striped table-condensed'});
    $view.append($table);

    // Header
    $row = $('<tr>');
    $row.append($('<th>Name</th>'));
    $row.append($('<th>Inhabitants</th>'));
    $row.append($('<th>Infected</th>'));
    $row.append($('<th>Percentage</th>'));
    $table.append($row);

    // Rows
    for(town in this.towns){
        $row = $('<tr>', {id:noSpace(town)});
        $row.append($('<td>' + town + '</td>'));
        $row.append($('<td>' + this.towns[town].size + '</td>'));
        $row.append($('<td>', {class:'infected'}));
        $row.append($('<td>', {class:'percent'}));
        $table.append($row);
    }
}

/// If given a valid day, update the view to match the info at that day.
Visualizer.prototype.updateDay = function(day){
    // Make sure it's a valid day to visualize.
    if(day >= this.maxDays || day < 0){
        console.log(`Invalid day: ${day}.`)
        return;
    }

    this.day = day;
    $('.current-day').text(this.day);

    this.updateView();
}

/// Update the view to reflect the currently selected day.
Visualizer.prototype.updateView = function(){
    if( this.mode == "table")
        this.updateTable();
    else
        this.updateMap();
}

/// Update the table to reflect the currently selected day.
Visualizer.prototype.updateTable = function(){
    var currentDay = this.days[this.day];
    var total = 0;
    // Update the view further
    for(town in this.towns){
        // If there's no measurement, then it must be zero
        total += val = currentDay[town] || 0;
        // Put the amount of infected
        $('#' + noSpace(town) + ' .infected').text(val);
        // Write the percentage of infected if any
        var percent = val/this.towns[town].size*100;
        $('#' + noSpace(town) + ' .percent').text(percent? percent.toFixed(1)+'%' : '');
    }
    // Put the total infected where we can see it.
    $('.total-infected').text(total);
}


// User control:

function prevDay(){
    visualizer.updateDay(visualizer.day - 1);
}
function nextDay(){
    visualizer.updateDay(visualizer.day + 1);
}